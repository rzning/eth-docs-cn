# EIP-1193: Ethereum Provider JavaScript API

- <https://eips.ethereum.org/EIPS/eip-1193>
- <https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1193.md>
- <https://learnblockchain.cn/docs/eips/eip-1193.html>

> A JavaScript Ethereum Provider API for consistency across clients and applications.

ä¸€ä¸ª JavaScript ä»¥å¤ªåŠæä¾›è€… API ï¼Œç”¨äºå®ç°ä»¥å¤ªåŠå®¢æˆ·ç«¯ä¸åº”ç”¨ç¨‹åºä¹‹é—´çš„ä¸€è‡´æ€§ã€‚

## æ‘˜è¦ Abstract

ä»¥å¤ªåŠç½‘ç»œåº”ç”¨ç¨‹åº ( DApp ) ç”Ÿæ€ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå¸¸è§çº¦å®šæ˜¯ï¼š
å¯†é’¥ç®¡ç†è½¯ä»¶ï¼ˆé’±åŒ… ( Wallets ) ï¼‰é€šè¿‡ç½‘é¡µä¸­çš„ JavaScript å¯¹è±¡å…¬å¼€å…¶ API ã€‚

è¿™ä¸ªå…¬å¼€çš„å¯¹è±¡ç§°ä¸ºæä¾›è€… ( Provider ) ã€‚

è¯¥ EIP å°†ä»¥å¤ªåŠ Provider API æ­£å¼åŒ–ï¼Œä»¥ä¿ƒè¿› Wallet çš„äº’æ“ä½œæ€§ã€‚

æ­¤ API è¢«è®¾è®¡ä¸ºæœ€å°çš„ã€äº‹ä»¶é©±åŠ¨çš„ã€å¹¶ä¸”ä¸ä¼ è¾“å’Œ RPC åè®®æ— å…³ã€‚

é€šè¿‡å®šä¹‰æ–°çš„ RPC æ–¹æ³•å’Œ `message` äº‹ä»¶ç±»å‹ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰©å±•å…¶åŠŸèƒ½ã€‚

## è§„èŒƒ Specification

### ğŸ”µ æœ¯è¯­ Definitions

æœ¬èŠ‚æ˜¯éè§„èŒƒçš„ã€‚

| Name     | åç§°         | æè¿°                                                                                                                 |
| -------- | ------------ | -------------------------------------------------------------------------------------------------------------------- |
| Provider | æä¾›è€…       | ä¸€ä¸ªå¯ä¾›æ¶ˆè´¹è€… ( Consumer ) ä½¿ç”¨çš„ JavaScript å¯¹è±¡ï¼Œå®ƒé€šè¿‡å®¢æˆ·ç«¯æä¾›å¯¹ä»¥å¤ªåŠçš„è®¿é—®ã€‚                                 |
| Client   | å®¢æˆ·ç«¯       | ä» Provider æ¥æ”¶ RPC è¯·æ±‚å¹¶è¿”å›å…¶ç»“æœçš„ç«¯ç‚¹ã€‚                                                                        |
| Wallet   | é’±åŒ…         | ä¸€ä¸ªç®¡ç†ç§é’¥ã€æ‰§è¡Œç­¾åæ“ä½œã€å¹¶å……å½“ Provider å’Œ Client ä¹‹é—´çš„ä¸­é—´ä»¶çš„ç»ˆç«¯ç”¨æˆ·åº”ç”¨ç¨‹åºã€‚                               |
| RPC      | è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ | Remote Procedure Call - æ˜¯æäº¤ç»™ Provider çš„ä»»ä½•è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚å°†ç”±ä¸€ä¸ª Provider ã€å®ƒçš„ Wallet æˆ–è€…å®ƒçš„ Client å¤„ç†ã€‚ |

### ğŸ”µ è¿é€šæ€§ Connectivity

- å½“ Provider å¯ä»¥ä¸ºè‡³å°‘ä¸€ä¸ªé“¾çš„ RPC è¯·æ±‚æä¾›æœåŠ¡æ—¶ï¼Œç§° Provider ä¸ºå·²è¿æ¥ ( Connected ) ã€‚
- å½“ Provider æ— æ³•ä¸ºä»»ä½•é“¾çš„ RPC è¯·æ±‚æä¾›æœåŠ¡æ—¶ï¼Œç§° Provider ä¸ºæ–­å¼€è¿æ¥ ( Disconnected ) ã€‚

### ğŸ”µ API

- æä¾›è€… ( Provider ) å¿…é¡»å®ç°å¹¶å…¬å¼€æœ¬èŠ‚ä¸­å®šä¹‰çš„ API ï¼Œå¹¶ä¸”æ‰€æœ‰ API å¿…é¡»éµå¾ªæœ¬èŠ‚å®šä¹‰çš„ç±»å‹å’Œæ¥å£ã€‚

#### `Provider.request({ method, params })`

> è¯¥ `request()` æ–¹æ³•æ—¨åœ¨ä½œä¸º RPC çš„ä¼ è¾“å’Œåè®®æ— å…³çš„ wrapper å‡½æ•°ã€‚

```ts
interface RequestArguments {
  /**
   * è¯·æ±‚çš„ RPC æ–¹æ³•å
   */
  readonly method: string
  /**
   * è¯·æ±‚çš„ RPC æ–¹æ³•æ¥æ”¶çš„ä»»ä½•å‚æ•°
   */
  readonly params?: readonly unknown[] | object
}

interface Provider {
  /**
   * è¯·æ±‚ä¸€ä¸ª RPC æ–¹æ³•
   *
   * - å¿…é¡»å¤„ç†å…¶ä¸­çš„ RPC æ–¹æ³•
   *
   * @returns resolve RPC æ–¹æ³•çš„å€¼ï¼Œæˆ–è€… rejects ä¸€ä¸ªé”™è¯¯ã€‚
   */
  request(args: RequestArguments): Promise<unknown>
}
```

- å¦‚æœè¿”å›çš„ Promise æ˜¯ reject çŠ¶æ€ï¼Œåˆ™å®ƒå¿…é¡»æ˜¯ä¸‹é¢ RPC Errors éƒ¨åˆ†å®šä¹‰çš„ `ProviderRpcError` ã€‚

å¦‚æœæ»¡è¶³ä¸‹é¢ä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œè¿”å›çš„ Promise å¿…é¡» ( MUST ) reject ï¼š

- RPC è¯·æ±‚è¿”å›é”™è¯¯ã€‚
- Provider é‡åˆ°é”™è¯¯ï¼Œæˆ–ç”±äºä»»ä½•åŸå› æœªèƒ½å¤„ç†è¯·æ±‚ã€‚

å¦‚æœæ»¡è¶³ä¸‹é¢ä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œè¿”å›çš„ Promise åº”è¯¥ ( SHOULD ) reject ï¼š

- Provider å·²æ–­å¼€è¿æ¥ ( `code: 4900` )
- RPC è¯·æ±‚æŒ‡å‘ä¸€ä¸ªç‰¹å®šçš„é“¾ï¼Œå¹¶ä¸” Provider æ²¡æœ‰è¿æ¥åˆ°è¯¥é“¾ï¼Œä½†æ˜¯è¿æ¥åˆ°äº†è‡³å°‘ä¸€ä¸ªå…¶ä»–é“¾ ( `code: 4901` )

### ğŸ”µ å—æ”¯æŒçš„ RPC æ–¹æ³•

- å—æ”¯æŒçš„ RPC æ–¹æ³•æ˜¯ä»»ä½•å¯ä»¥é€šè¿‡ Provider è°ƒç”¨çš„ PRC æ–¹æ³•ã€‚
- æ‰€æœ‰æ”¯æŒçš„ RPC æ–¹æ³•å¿…é¡»æ‹¥æœ‰å”¯ä¸€çš„å­—ç¬¦ä¸²æ ‡è¯†ã€‚
- Provider å¯ä»¥æ”¯æŒä¸ºå®ç°å…¶ç›®çš„æ‰€éœ€çš„ä»»ä½• RPC æ–¹æ³•ï¼Œæ— è®ºæ˜¯æ ‡å‡†åŒ–çš„è¿˜æ˜¯å…¶ä»–çš„ã€‚
- å¦‚æœä¸€ä¸ªåœ¨æœ€ç»ˆ EIP ä¸­å®šä¹‰çš„ RPC æ–¹æ³•ä¸è¢«æ”¯æŒï¼Œ
  å®ƒåº”è¯¥ä»¥ `4200` é”™è¯¯ï¼ˆæ ¹æ®ä¸‹é¢ Provider Errors éƒ¨åˆ† ï¼‰
  æˆ–è€…ä¸€ä¸ªé€‚å½“çš„é”™è¯¯ï¼ˆæ ¹æ® RPC æ–¹æ³•çš„è§„èŒƒï¼‰ reject ã€‚

### ğŸ”µ RPC Errors

```ts
interface ProviderRpcError extends Error {
  /**
   * é”™è¯¯æ¶ˆæ¯ï¼šå¿…é¡»æ˜¯äººç±»å¯è¯»çš„å­—ç¬¦ä¸²
   */
  message: string
  /**
   * é”™è¯¯ç ï¼šå¿…é¡»æ˜¯æ•´æ•°
   */
  code: number
  /**
   * åº”è¯¥åŒ…å«å…³äºé”™è¯¯çš„å…¶ä»–æœ‰ç”¨ä¿¡æ¯
   */
  data?: unknown
}
```

`ProviderRpcError` åº”è¯¥æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºéµå¾ªä»¥ä¸‹çº¦å®šï¼š

1. ä»¥ä¸‹ Provider Errors ä¸­çš„é”™è¯¯
2. RPC æ–¹æ³•è§„èŒƒè§„å®šçš„ä»»ä½•é”™è¯¯
3. [`CloseEvent` çŠ¶æ€ç ](https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent#Status_codes)

### ğŸ”µ Provider Errors

| Status code | Name                  | æè¿°                              |
| ----------- | --------------------- | --------------------------------- |
| 4001        | User Rejected Request | ç”¨æˆ·æ‹’ç»è¯·æ±‚                      |
| 4100        | Unauthorized          | è¯·æ±‚çš„æ–¹æ³•å’Œ/æˆ–è´¦æˆ·æ²¡æœ‰è¢«ç”¨æˆ·æˆæƒ |
| 4200        | Unsupported Method    | Provider ä¸æ”¯æŒè¯·æ±‚çš„æ–¹æ³•         |
| 4900        | Disconnected          | Provider å·²ä¸æ‰€æœ‰é“¾æ–­å¼€è¿æ¥       |
| 4901        | Chain Disconnected    | Provider æ²¡æœ‰è¿æ¥åˆ°è¯·æ±‚çš„é“¾       |

- æ¢å¥è¯è¯´ï¼Œ `4901` æ„å‘³ç€ Provider è¿æ¥åˆ°äº†å…¶ä»–é“¾ï¼Œè€Œä¸æ˜¯è¢«è¯·æ±‚çš„é“¾ã€‚

### ğŸ”µ Events

Provider å¿…é¡»å®ç°ä¸€ä¸‹äº‹ä»¶å¤„ç†æ–¹æ³•ï¼š

- `on()`
- `removeListener()`

è¿™äº›æ–¹æ³•å¿…é¡»éµå¾ª Node.js çš„ [`EventEmitter` API](https://nodejs.org/api/events.html) å®ç°ã€‚

| Event             | æè¿°                                                                                     |
| ----------------- | ---------------------------------------------------------------------------------------- |
| `message`         | æ¶ˆæ¯ `message` äº‹ä»¶ç”¨äºå…¶ä»–äº‹ä»¶æœªæ¶µç›–çš„ä»»æ„é€šçŸ¥ã€‚                                        |
| Subscription      | å½“ Provider æ”¶åˆ°ä»¥å¤ªåŠ RPC è®¢é˜…æ¶ˆæ¯é€šçŸ¥æ—¶è§¦å‘ç±»å‹ä¸º `eth_subscription` çš„ `message` äº‹ä»¶ |
| `connect`         | å½“ Provider ä¸ä¸€ä¸ªé“¾æˆåŠŸè¿æ¥æ—¶è§¦å‘                                                       |
| `disconnect`      | å½“ Provider ä¸æ‰€æœ‰çš„é“¾æ–­å¼€è¿æ¥æ—¶è§¦å‘                                                     |
| `chainChanged`    | å½“ Provider æ‰€è¿æ¥çš„é“¾å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘                                                     |
| `accountsChanged` | å½“ Provider å¯ç”¨çš„è´¦æˆ·å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘                                                     |

## åŸºæœ¬åŸç† Rationale

æä¾›è€… ( Provider ) çš„ç›®çš„æ˜¯ä¸ºæ¶ˆè´¹è€… ( Consumer ) æä¾›ä»¥å¤ªåŠçš„è®¿é—®ã€‚

é€šå¸¸ Provider å¿…é¡»ä½¿ä»¥å¤ªåŠ Web åº”ç”¨ç¨‹åºèƒ½å¤Ÿåšä¸¤ä»¶äº‹ï¼š

- å‘é€ Ethereum RPC è¯·æ±‚
- å“åº” Provider çš„ä»¥å¤ªåŠé“¾ã€å®¢æˆ·ç«¯å’Œé’±åŒ…ä¸­çš„çŠ¶æ€å˜åŒ–

Provider API è§„èŒƒç”±ä¸€ä¸ªæ–¹æ³•å’Œäº”ä¸ªäº‹ä»¶ç»„æˆï¼š

- ä»…ä½¿ç”¨ `request()` æ–¹æ³•å’Œ `message` äº‹ä»¶ï¼Œå°±è¶³çŸ£å®ç°ä¸€ä¸ªå®Œæ•´çš„ Provider
- `request()` æ–¹æ³•ç”¨äºå‘é€ä»»æ„ RPC è¯·æ±‚
- `message` äº‹ä»¶ç”¨äºä¼ é€’ä»»æ„æ¶ˆæ¯
- å…¶ä½™å››ä¸ªäº‹ä»¶å¯åˆ†ä¸ºä¸¤ç±»ï¼š
  - Provider å‘é€ RPC è¯·æ±‚èƒ½åŠ›çš„æ”¹å˜:
    - `connect`
    - `disconnect`
  - é€šç”¨å®¢æˆ·ç«¯å’Œ/æˆ–é’±åŒ…çŠ¶æ€çš„æ”¹å˜ï¼š
    - `chainChanged`
    - `accountsChanged`

## å®ç° Implementations

- buidler.dev
- ethers.js
- eth-provider
- [MetaMask](https://github.com/MetaMask/providers)
- WalletConnect
- [web3.js](http://web3js.readthedocs.io)

## é™„å½•ä¸€ï¼šé¢å‘æ¶ˆè´¹è€… ( Consumer ) çš„ API æ–‡æ¡£

### ğŸ”µ æ–¹æ³• `request()`

è°ƒç”¨ä»¥å¤ªåŠ RPC æ–¹æ³•ï¼š

```js
Provider.request({ method: 'eth_accounts' })
  .then((accounts) => console.log(accounts))
  .catch((error) => console.error(error))
```

RPC åè®® ( Protocols ) ï¼š

- EIP-1474 : Ethereum JSON-RPC API
- EIP-1767 : Ethereum GraphQL schema

### ğŸ”µ äº‹ä»¶ Events

## é™„å½•äºŒï¼šä¾‹å­

## é™„å½•ä¸‰ï¼šé—ç•™çš„æä¾›è€… ( Provider ) API
